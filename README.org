:PROPERTIES:
:header-args: :results verbatim :exports both
:END:
#+title: its-jointprobability
#+EXPORT_EXCLUDE_TAGS: noexport

A Bayesian approach to generating metadata for educational materials.

This project is primarily intended to be used as a microservice through the ~nix~ package. Additionally, it includes some CLI utilities in order to (re-) train the model for some data (data not included).

* Utils :noexport:
#+name: format-json
#+begin_src shell sh :var result="" :results verbatim
echo $result | json
#+end_src

#+name: format-prediction
#+begin_src python :var result="" :results output :session python-jointprobability-demo
import json
import pandas as pd
result_dict = json.loads(result)["predictions"]
for key, value in sorted(list(result_dict.items())):
    print(key)
    print("--------------------------------------------------------------------")
    df = pd.DataFrame.from_dict(value).set_index("name")
    df = df.drop("id", axis=1)
    df["prob_interval"] = df.apply(lambda x: [f"{y:g}" for y in x["prob_interval"]], axis=1)
    print(df.to_string())
    print()
#+end_src

* Usage

** Service

With ~Nix~, no further installation is required to run the microservice. Simply run the following command:
#+begin_src shell
nix run github:openeduhub/its-jointprobability
#+end_src
or optionally, with CUDA support:
#+begin_src shell
nix run "github:openeduhub/its-jointprobability#with-cuda"
#+end_src

If the package has been installed locally, the service is also available as ~its-jointprobability~ from the command line.

For more information on configuration options, see
#+begin_src shell
nix run github:openeduhub/its-jointprobability -- --help
#+end_src

Once started, see the ~Swagger~ UI for documentation on the service.
It is located on =http://localhost:8080/docs= by default.

** Model Training

To retrain the model under some data, use the included ~retrain-model~ CLI tool, e.g. through
#+begin_src shell
nix run "github:openeduhub/its-jointprobability#retrain-model" -- <path/to/data-dir>
#+end_src
or, *highly recommended*, with CUDA:
#+begin_src shell
nix run "github:openeduhub/its-jointprobability#retrain-model-with-cuda" -- <path/to/data-dir>
#+end_src

The utility will look for =train_data= and =train_labels=, which are assumed to files that can be loaded through [[https://pytorch.org/docs/stable/generated/torch.load.html][torch.load]]. These should be (=float=-type) [[https://pytorch.org/docs/stable/tensors.html#torch.Tensor][torch.Tensor]] objects with the following content:
- ~train_data_labeled~ :: a two-dimensional =Tensor= where the first dimension corresponds to the individual documents to use for training and the second dimensions contains each document's content, encoded through their Bag-of-words representation.
- ~train_targets~ :: a two-dimensional =Tensor= where the first dimension corresponds to the individual documents to use for training and the second dimension encodes whether each document belongs to each discipline (=1.0= if it does, =0.0= otherwise).

Once the data has been loaded, the topic model will be trained (this will take a long time) and saved within the set directory under =prodslda=. If this file already exists, this step is skipped.

Finally, the Bayesian classification model is trained and saved under =classification=. At this point, some quality metrics will be computed for the model on the training data. If ~test_data_labeled~ and ~test_targets~ are present in the given directory (analogous to the training data), these quality metrics will also be computed for this testing data.

** As a Python Library
:PROPERTIES:
:header-args: :session *python:its-jointprobability-demo* :results output :exports both :async yes
:END:

When doing larger scale analysis, using the model through a REST API may not be very convenient, especially because of the lack of proper parallelization of batches and thus much higher hardware utilization than would be possible.

For such use-cases, using the Python library directly is recommended. See [[Python Library]] for details on how to install the library through the provided ~nixpkgs~ overlay. Alternatively, using ~pip~ may also work.

*** For Inference

To load a pre-trained model, e.g. from https://gitlab.gwdg.de/jopitz/its-jointprobability-model, load the corresponding =ProdSLDA_{kwargs|pyro|state}.pt= files using ~its_jointprobability.data.load_model~:

#+begin_src python
from pathlib import Path
import torch
from its_jointprobability.models.prodslda import ProdSLDA
from its_jointprobability.data import load_model

model_path = Path("../its-jointprobability-model")
# use CUDA if it is available
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model = load_model(ProdSLDA, model_path, device=device)

print(model)
#+end_src

#+RESULTS:
#+begin_example
ProdSLDA(
  (decoder): Sequential(
    (0): Linear(in_features=500, out_features=1000, bias=True)
    (1): Tanh()
    (2): Dropout(p=0.6, inplace=False)
    (3): Linear(in_features=1000, out_features=20918, bias=True)
    (4): BatchNorm1d(20918, eps=1e-05, momentum=0.1, affine=False, track_running_stats=True)
    (5): Softmax(dim=-1)
  )
  (encoder): Sequential(
    (0): Linear(in_features=20918, out_features=1000, bias=True)
    (1): Tanh()
    (2): Dropout(p=0.6, inplace=False)
    (3): Linear(in_features=1000, out_features=1000, bias=True)
    (4): BatchNorm1d(1000, eps=1e-05, momentum=0.1, affine=False, track_running_stats=True)
  )
)
#+end_example

Now, we can run inference on arbitrary texts by simply using the ~predict_from_texts~ method of the model:
#+begin_src python
texts = [
    "Der Satz des Pythagoras lautet: a^2 + b^2 = c^2",
    "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.",
]

predictions = list(
    model.predict_from_texts(*texts, tokens=model.vocab, num_samples=1000)
)
#+end_src

#+RESULTS:
: posterior sample: 100% 4/4 [00:03<00:00,  1.12it/s]
: posterior sample: 100% 19/19 [00:18<00:00,  1.00it/s]

#+begin_src python
from pprint import pprint

# print the most relevant predictions for the school discipline
print("Most relevant")
print("-------------")
for text, prediction in zip(texts, predictions):
    print(text)
    pprint(
        sorted(
            prediction["properties.ccm:taxonid"],
            key=lambda x: x.baseline_diff,
            reverse=True,
        )[:5]
    )
    print()
    
# print the least relevant predictions for the school discipline
print("Least relevant")
print("--------------")
for text, prediction in zip(texts, predictions):
    print(text)
    pprint(
        sorted(
            prediction["properties.ccm:taxonid"],
            key=lambda x: x.baseline_diff,
            reverse=False,
        )[:5]
    )
    print()
#+end_src

#+RESULTS:
#+begin_example
Most relevant
-------------
Der Satz des Pythagoras lautet: a^2 + b^2 = c^2
[Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/380', name='Mathematik', mean_prob=0.27252691984176636, median_prob=0.2375515103340149, baseline_diff=0.08902664482593536, prob_interval=[0.03836498036980629, 0.4274231195449829]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/400', name='Mediendidaktik', mean_prob=0.20079974830150604, median_prob=0.16239628195762634, baseline_diff=0.04250064492225647, prob_interval=[0.02097034826874733, 0.31550872325897217]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/44099', name='Open Educational Resources', mean_prob=0.19592401385307312, median_prob=0.1562144011259079, baseline_diff=0.02785569429397583, prob_interval=[0.028453882783651352, 0.3012710511684418]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/04014', name='Arbeitssicherheit', mean_prob=0.2014719545841217, median_prob=0.16092683374881744, baseline_diff=0.025998622179031372, prob_interval=[0.012373332865536213, 0.31377604603767395]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/44007', name='Sozialpädagogik', mean_prob=0.17032858729362488, median_prob=0.13969334959983826, baseline_diff=0.024959757924079895, prob_interval=[0.015507511794567108, 0.2542083263397217])]

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
[Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/400', name='Mediendidaktik', mean_prob=0.21222397685050964, median_prob=0.1725321114063263, baseline_diff=0.05392487347126007, prob_interval=[0.02645198069512844, 0.35374367237091064]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/20002', name='Französisch', mean_prob=0.24668413400650024, median_prob=0.2100289762020111, baseline_diff=0.047679975628852844, prob_interval=[0.026496760547161102, 0.3796420097351074]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/44006', name='Sonderpädagogik', mean_prob=0.21014226973056793, median_prob=0.16691946983337402, baseline_diff=0.03631836175918579, prob_interval=[0.012180385179817677, 0.33394092321395874]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/160', name='Ethik', mean_prob=0.22378790378570557, median_prob=0.19213445484638214, baseline_diff=0.035237476229667664, prob_interval=[0.027888188138604164, 0.3623582422733307]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/380', name='Mathematik', mean_prob=0.21647676825523376, median_prob=0.16698753833770752, baseline_diff=0.03297649323940277, prob_interval=[0.020263776183128357, 0.3488425314426422])]

Least relevant
--------------
Der Satz des Pythagoras lautet: a^2 + b^2 = c^2
[Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/240', name='Geschichte', mean_prob=0.3266444802284241, median_prob=0.29558679461479187, baseline_diff=-0.08436188101768494, prob_interval=[0.06395381689071655, 0.513274610042572]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/64018', name='Nachhaltigkeit', mean_prob=0.15481287240982056, median_prob=0.12479785084724426, baseline_diff=-0.04677225649356842, prob_interval=[0.009936170652508736, 0.238087460398674]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/04005', name='Elektrotechnik', mean_prob=0.14669086039066315, median_prob=0.11050695925951004, baseline_diff=-0.03920416533946991, prob_interval=[0.010430517606437206, 0.23249176144599915]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/900', name='Medienbildung', mean_prob=0.18447546660900116, median_prob=0.143831267952919, baseline_diff=-0.03595893085002899, prob_interval=[0.020866503939032555, 0.29167866706848145]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/04011', name='Metalltechnik', mean_prob=0.12942147254943848, median_prob=0.10473495721817017, baseline_diff=-0.03176121413707733, prob_interval=[0.010282553732395172, 0.19191618263721466])]

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
[Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/64018', name='Nachhaltigkeit', mean_prob=0.151003897190094, median_prob=0.1168498769402504, baseline_diff=-0.05058123171329498, prob_interval=[0.018730375915765762, 0.23541297018527985]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/04005', name='Elektrotechnik', mean_prob=0.14392922818660736, median_prob=0.11002340912818909, baseline_diff=-0.041965797543525696, prob_interval=[0.01008471567183733, 0.22575043141841888]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/04011', name='Metalltechnik', mean_prob=0.12236656248569489, median_prob=0.08735257387161255, baseline_diff=-0.03881612420082092, prob_interval=[0.0064668068662285805, 0.18605364859104156]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/72001', name='Zeitgemäße Bildung', mean_prob=0.1414533108472824, median_prob=0.10465358942747116, baseline_diff=-0.03346985578536987, prob_interval=[0.009646143764257431, 0.22923143208026886]),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/240', name='Geschichte', mean_prob=0.37926897406578064, median_prob=0.3509242534637451, baseline_diff=-0.03173738718032837, prob_interval=[0.06747578829526901, 0.5976729989051819])]
#+end_example

* REST API
:PROPERTIES:
:header-args: :results verbatim :exports both :post format-json(result=*this*) :wrap src
:END:

** Ping

Once the service has started, we can ping it to check that it is responding to requests:
#+begin_src shell :post :exports both
curl -i -X GET http://localhost:8080/_ping
#+end_src

#+RESULTS:
#+begin_src
HTTP/1.1 200 OK
date: Mon, 15 Jan 2024 15:34:05 GMT
server: uvicorn
content-length: 4
content-type: application/json

null
#+end_src

** Predictions
:PROPERTIES:
:header-args: :results verbatim :exports both :post format-prediction(result=*this*)
:END:

With the =/predict= endpoint, we can send a text to the model. For readability, we only ask for the seven most relevant categories for each metadata field.

In addition to the identifiers of the predicted metadata, we also get some diagnostics that help us understand whether this is a relevant match (in principle, all categories are always returned). Specifically, we gain two point-estimates (mean and median) for the probability of the category belonging to the given text, according to the model. We also get the difference to the "baseline" (i.e. an empty text) and a credibility interval (by default 80%) on said probability.

In the example below, we get only one relevant school discipline, which is also the one we would be expecting for the text (Mathematics). Because the text is relatively short, the probability of this fit is still relatively low. We also get a strong match with Sekundarstufe I, which is also what we would expect, given that Pythagoras' Theorem is usually covered in early High School.
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "Der Satz des Pythagoras lautet: a^2 + b^2 = c^2. Er wird benutzt, um die Hypotenuse eines rechtwinkligen Dreiecks zu berechnen.",
  "num_predictions": "7"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                                           mean_prob  median_prob  baseline_diff          prob_interval
name                                                                                                   
Krieg und Frieden                           0.499650     0.497781       0.287354    [0.15046, 0.744354]
Vögel                                       0.433680     0.407043       0.255187  [0.0917084, 0.653437]
Geschichte                                  0.423316     0.408072       0.220652   [0.117071, 0.662006]
Permanentmagnetismus                        0.400287     0.391695       0.206084   [0.115225, 0.653262]
Geschichte der Pädagogik und der Kindheit   0.391558     0.325493       0.249145  [0.0965705, 0.652269]
Multiplikation                              0.379555     0.356258       0.189535   [0.128819, 0.604945]
Landesgeschichte                            0.372289     0.350806       0.188352  [0.0708283, 0.530522]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff          prob_interval
name                                                                            
Sekundarstufe II     0.693915     0.750605      -0.018809   [0.461678, 0.898913]
Sekundarstufe I      0.633262     0.648296      -0.077690   [0.399331, 0.851106]
Primarstufe          0.358779     0.337108      -0.349428  [0.0905297, 0.539697]
Erwachsenenbildung   0.283585     0.258247       0.007470  [0.0442004, 0.455388]
Berufliche Bildung   0.196681     0.156372      -0.021120  [0.0426586, 0.330467]
Elementarbereich     0.180557     0.129697      -0.023901  [0.0201766, 0.275723]
Hochschule           0.157080     0.122083      -0.067659  [0.0235917, 0.253844]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff          prob_interval
name                                                                    
Lerner/in    0.707223     0.729993      -0.061725   [0.573769, 0.939774]
Lehrer/in    0.692565     0.701207       0.037719   [0.521068, 0.927965]
Eltern       0.244146     0.197916      -0.182602    [0.03858, 0.333899]
andere       0.213503     0.178225       0.037175  [0.0280832, 0.358679]
Autor/in     0.199722     0.152680       0.041663  [0.0260055, 0.327576]
Berater/in   0.173402     0.123309      -0.011933  [0.0155672, 0.276009]
Verwaltung   0.170655     0.123705      -0.000385  [0.0319253, 0.270608]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                      mean_prob  median_prob  baseline_diff          prob_interval
name                                                                                              
Material                               0.402455     0.376048      -0.076755   [0.137398, 0.600175]
Arbeitsblatt                           0.394954     0.362732       0.119269   [0.130681, 0.591375]
Erklärvideo und gefilmtes Experiment   0.316604     0.271757      -0.031644  [0.0923226, 0.508483]
Tool                                   0.310405     0.256607       0.085608  [0.0666579, 0.516319]
Unterrichtsbaustein                    0.294218     0.281836       0.035203  [0.0590224, 0.447102]
Übungsmaterial                         0.283933     0.248295       0.064851  [0.0546868, 0.433396]
Wiki (dynamisch)                       0.273996     0.212178       0.043278  [0.0537248, 0.476948]

properties.ccm:taxonid
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff          prob_interval
name                                                                    
Mathematik   0.535516     0.556164       0.368982   [0.349688, 0.816922]
Allgemein    0.265409     0.229623      -0.126465   [0.078655, 0.420106]
Ethik        0.220546     0.193496       0.021178  [0.0278748, 0.308421]
Chemie       0.219924     0.180864       0.013061  [0.0425142, 0.354059]
Physik       0.216721     0.172192       0.017618  [0.0277188, 0.328015]
Informatik   0.211494     0.177548       0.021298  [0.0354947, 0.308914]
Biologie     0.200423     0.166586       0.020249  [0.0449775, 0.332973]
#+end_example

Note that these predictions are stochastic, so another run on the same text may yield slightly different predictions:
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "Der Satz des Pythagoras lautet: a^2 + b^2 = c^2. Er wird benutzt, um die Hypotenuse eines rechtwinkligen Dreiecks zu berechnen.",
  "num_predictions": "7"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                                                        mean_prob  median_prob  baseline_diff          prob_interval
name                                                                                                                
Satzgruppe des Pythagoras                                0.425188     0.411264       0.246590   [0.139236, 0.725673]
Ableitungen in Sachzusammenhängen                        0.379597     0.361325       0.188042  [0.0761039, 0.584629]
Überwachung                                              0.365457     0.330208       0.186731   [0.067446, 0.573907]
Ableitung und Stammfunktionen von Exponentiafunktionen   0.352382     0.314845       0.191486  [0.0748244, 0.552895]
Runden und Überschlag                                    0.349584     0.292060       0.136565  [0.0630526, 0.525037]
Wurfbewegungen                                           0.347295     0.315187       0.185624  [0.0733593, 0.533427]
MINT-Fächer                                              0.329261     0.283968       0.197457  [0.0971537, 0.541376]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff          prob_interval
name                                                                            
Sekundarstufe II     0.686577     0.716279      -0.026146   [0.541162, 0.920923]
Sekundarstufe I      0.675070     0.673988      -0.035882   [0.454933, 0.886076]
Primarstufe          0.400799     0.379878      -0.307408   [0.137888, 0.633204]
Erwachsenenbildung   0.308383     0.273281       0.032269  [0.0664014, 0.472019]
Förderschule         0.230436     0.172596       0.043758  [0.0293185, 0.388129]
Hochschule           0.220565     0.188415      -0.004173  [0.0222665, 0.344592]
Berufliche Bildung   0.219855     0.210381       0.002054  [0.0295881, 0.291025]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff          prob_interval
name                                                                    
Lerner/in    0.795696     0.833256       0.026749   [0.685567, 0.984279]
Lehrer/in    0.627021     0.660895      -0.027824   [0.376339, 0.904505]
Eltern       0.244630     0.209641      -0.182117   [0.033831, 0.374067]
Verwaltung   0.212595     0.191128       0.041555  [0.0242546, 0.300284]
andere       0.211714     0.171853       0.035387  [0.0270535, 0.337305]
Berater/in   0.198808     0.148358       0.013473  [0.0179973, 0.331925]
Autor/in     0.138079     0.112256      -0.019980  [0.0249124, 0.207295]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                      mean_prob  median_prob  baseline_diff          prob_interval
name                                                                                              
Material                               0.410655     0.394843      -0.068555   [0.171486, 0.699325]
Arbeitsblatt                           0.364659     0.347958       0.088974    [0.122971, 0.58197]
Erklärvideo und gefilmtes Experiment   0.338693     0.309849      -0.009555   [0.126242, 0.589911]
Tool                                   0.308167     0.277313       0.083371   [0.0728664, 0.48798]
Wiki (dynamisch)                       0.276762     0.267582       0.046044  [0.0299357, 0.416765]
Audio                                  0.273183     0.231107      -0.352067  [0.0677331, 0.434536]
Dokumente und textbasierte Inhalte     0.267379     0.227819       0.049034  [0.0153613, 0.384841]

properties.ccm:taxonid
--------------------------------------------------------------------
                                mean_prob  median_prob  baseline_diff          prob_interval
name                                                                                        
Mathematik                       0.590420     0.587209       0.423887   [0.427773, 0.880495]
Astronomie                       0.224137     0.166060       0.057614  [0.0190818, 0.373102]
Umweltgefährdung, Umweltschutz   0.219973     0.185988       0.042489  [0.0418655, 0.356185]
Allgemein                        0.219401     0.186229      -0.172473  [0.0600868, 0.340469]
Open Educational Resources       0.219387     0.182230       0.050510   [0.0430368, 0.37363]
Physik                           0.216058     0.162539       0.016954  [0.0294892, 0.374956]
Ethik                            0.205835     0.166425       0.006467  [0.0153541, 0.315831]
#+end_example

To reduce this variance, we can increase the number of samples being drawn for the prediction. Note that the computation time is proportional to the number of such samples. By default, 100 samples are drawn.
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "Der Satz des Pythagoras lautet: a^2 + b^2 = c^2. Er wird benutzt, um die Hypotenuse eines rechtwinkligen Dreiecks zu berechnen.",
  "num_predictions": "7",
  "num_samples": "10000"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                                                        mean_prob  median_prob  baseline_diff            prob_interval
name                                                                                                                  
Radioaktivität und Zerfallsarten                         0.205480     0.151855       0.021180     [0.00550835, 0.3452]
Totalitäre Erziehung im Nationalsozialismus              0.203669     0.145088       0.046498  [0.000981834, 0.339561]
Ableitung und Stammfunktionen von Exponentiafunktionen   0.203086     0.145961       0.042190   [0.00178288, 0.336871]
Biologie                                                 0.202478     0.154909      -0.000440   [0.00588039, 0.324147]
Das Wetter und was es mit uns macht                      0.198413     0.150349       0.001068   [0.00569635, 0.320682]
Analytische Geometrie                                    0.197661     0.136405       0.064169   [0.00297679, 0.333165]
Flächen berechnen                                        0.197009     0.145600       0.009336   [0.00617036, 0.318191]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff          prob_interval
name                                                                            
Sekundarstufe I      0.684543     0.713976      -0.026409   [0.509011, 0.948654]
Sekundarstufe II     0.620403     0.643488      -0.092321   [0.411814, 0.904636]
Primarstufe          0.322875     0.295565      -0.385332  [0.0569897, 0.499711]
Erwachsenenbildung   0.239126     0.201007      -0.036988  [0.0261164, 0.376804]
Berufliche Bildung   0.210261     0.171248      -0.007540  [0.0232107, 0.336557]
Hochschule           0.193507     0.155344      -0.031231  [0.0122484, 0.300012]
Fortbildung          0.185912     0.148806      -0.005011  [0.0183965, 0.294519]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff          prob_interval
name                                                                    
Lerner/in    0.803238     0.840564       0.034290   [0.693178, 0.982454]
Lehrer/in    0.679902     0.711437       0.025057   [0.497776, 0.941997]
Eltern       0.258753     0.222863      -0.167995  [0.0345901, 0.408037]
Autor/in     0.182599     0.146310       0.024539   [0.0141166, 0.28863]
Berater/in   0.179694     0.141434      -0.005641  [0.0116574, 0.278038]
Verwaltung   0.171261     0.135107       0.000221   [0.014968, 0.268576]
andere       0.155541     0.118477      -0.020787  [0.0116081, 0.243138]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                      mean_prob  median_prob  baseline_diff          prob_interval
name                                                                                              
Arbeitsblatt                           0.378756     0.358401       0.103070  [0.0956586, 0.584646]
Material                               0.374186     0.351545      -0.105024  [0.0954398, 0.578681]
Erklärvideo und gefilmtes Experiment   0.325985     0.296743      -0.022262  [0.0609582, 0.514314]
Unterrichtsbaustein                    0.284358     0.248523       0.025343  [0.0448811, 0.446575]
Übungsmaterial                         0.273936     0.239734       0.054855  [0.0455103, 0.431852]
Video (Material)                       0.270060     0.236802       0.133242  [0.0428537, 0.424454]
Tool                                   0.269583     0.233354       0.044787   [0.036021, 0.424174]

properties.ccm:taxonid
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff          prob_interval
name                                                                    
Mathematik   0.625596     0.650863       0.459062    [0.39371, 0.897381]
Allgemein    0.247097     0.213390      -0.144777  [0.0318952, 0.380678]
Physik       0.221454     0.185445       0.022350  [0.0261319, 0.349072]
Informatik   0.202126     0.167943       0.011930  [0.0237623, 0.312639]
Politik      0.194979     0.158857      -0.073368  [0.0232755, 0.305496]
Spanisch     0.191875     0.156635      -0.001314  [0.0204224, 0.303521]
Ethik        0.190708     0.153110      -0.008660  [0.0182104, 0.298631]
#+end_example

Second run, for comparison
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "Der Satz des Pythagoras lautet: a^2 + b^2 = c^2. Er wird benutzt, um die Hypotenuse eines rechtwinkligen Dreiecks zu berechnen.",
  "num_predictions": "7",
  "num_samples": "10000"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                            mean_prob  median_prob  baseline_diff           prob_interval
name                                                                                     
Sklaverei in Rom             0.200492     0.147916       0.061267  [0.00657755, 0.331799]
Schalenmodell nach Bohr      0.199613     0.141437       0.028229  [0.00336844, 0.335787]
Theaterstücke/Schullektüre   0.199428     0.139322       0.010591  [0.00440573, 0.321448]
Betrag eines Vektors         0.198864     0.149332       0.092907  [0.00815775, 0.320918]
Gleichförmige Bewegung       0.198639     0.144408       0.019785    [0.00525532, 0.3227]
Ökologische Landwirtschaft   0.198434     0.151422       0.024254  [0.00819371, 0.315024]
Design                       0.197394     0.144955      -0.085206  [0.00504897, 0.326171]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff          prob_interval
name                                                                            
Sekundarstufe I      0.672643     0.701005      -0.038309   [0.486417, 0.938629]
Sekundarstufe II     0.601034     0.618811      -0.111689   [0.378022, 0.894651]
Primarstufe          0.327022     0.297623      -0.381185  [0.0660629, 0.515329]
Erwachsenenbildung   0.233618     0.197254      -0.042496  [0.0295177, 0.371553]
Hochschule           0.214759     0.174421      -0.009980  [0.0182429, 0.334163]
Berufliche Bildung   0.205912     0.169117      -0.011889  [0.0192742, 0.321202]
Förderschule         0.183959     0.145154      -0.002719  [0.0141246, 0.288988]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff           prob_interval
name                                                                     
Lerner/in    0.796039     0.832104       0.027091    [0.679924, 0.979022]
Lehrer/in    0.669184     0.698234       0.014338    [0.488296, 0.947237]
Eltern       0.255434     0.220255      -0.171314   [0.0326233, 0.403247]
Verwaltung   0.188907     0.150098       0.017868   [0.0157259, 0.300072]
Berater/in   0.173505     0.136770      -0.011830   [0.0120783, 0.266528]
andere       0.169945     0.133358      -0.006382   [0.0128362, 0.261258]
Autor/in     0.160949     0.124320       0.002889  [0.00984534, 0.245873]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                      mean_prob  median_prob  baseline_diff          prob_interval
name                                                                                              
Arbeitsblatt                           0.383190     0.359807       0.107504    [0.09042, 0.593553]
Material                               0.381552     0.362450      -0.097658   [0.119445, 0.615487]
Erklärvideo und gefilmtes Experiment   0.336879     0.307078      -0.011369   [0.061867, 0.525541]
Unterrichtsbaustein                    0.275930     0.242100       0.016915  [0.0399328, 0.426918]
Übungsmaterial                         0.270931     0.235314       0.051849  [0.0348143, 0.423163]
Wiki (dynamisch)                       0.270668     0.234249       0.039951  [0.0413808, 0.425855]
Video (Material)                       0.266720     0.229168       0.129903  [0.0312192, 0.411689]

properties.ccm:taxonid
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff          prob_interval
name                                                                    
Mathematik   0.619988     0.646157       0.453455   [0.386183, 0.896136]
Allgemein    0.243661     0.208339      -0.148213  [0.0312403, 0.381514]
Physik       0.214072     0.178443       0.014968   [0.0266083, 0.33575]
Geschichte   0.208142     0.173192      -0.188029  [0.0249761, 0.324891]
Politik      0.203461     0.169557      -0.064885  [0.0183262, 0.311235]
Informatik   0.202511     0.166405       0.012314   [0.021765, 0.318216]
Chemie       0.191140     0.153794      -0.015723   [0.021123, 0.297839]
#+end_example

You may notice that the probabilities for other, less fitting, categories, are still relatively high. This is because the text is relatively short, so the model cannot conclude that e.g. a particular school discipline does not fit. This behavior becomes more extreme the shorter the given text is. Essentially, the model has been given too little data to decide for or against any one category. This can also be seen in low differences to the baseline probabilities and large credibility interval.

For an even more extreme example, see the following text. The probability that the 10th most likely school discipline applies, according to the model, is roughly as high as the fourth most likely school discipline in the longer text above -- there is simply not enough text to conclude that any of these disciplines do not apply, so the model defaults to roughly the overall frequencies in the training data. Conversely, the credibility intervals are larger and the differences to the baseline probabilities are smaller.
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "a^2 + b^2 = c^2.",
  "num_predictions": "10",
  "num_samples": "10000"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                                  mean_prob  median_prob  baseline_diff           prob_interval
name                                                                                           
Datenschutz                        0.224385     0.161833       0.057981  [0.00313944, 0.377442]
Länder, Regionen und Städte        0.223116     0.161167       0.066581  [0.00282862, 0.382265]
Literatur, Film und Theater        0.222860     0.164080       0.041083  [0.00533357, 0.371576]
Kunst verstehen                    0.219774     0.164460       0.071809  [0.00842244, 0.360248]
Zweiter Weltkrieg                  0.219370     0.151006       0.038190  [0.00354524, 0.379912]
Flächen berechnen                  0.218587     0.164930       0.030914  [0.00580142, 0.365164]
Biologie                           0.217704     0.166428       0.014786  [0.00264833, 0.358911]
Wetter, Klima, Globale Erwärmung   0.216681     0.148427       0.042602  [0.00660095, 0.356807]
Herero und Nama 1904 - 1908        0.215591     0.159307       0.070101  [0.00682106, 0.350608]
Feste, Bräuche und Traditionen     0.215276     0.147665      -0.016794  [0.00365277, 0.374491]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff          prob_interval
name                                                                            
Sekundarstufe I      0.693031     0.726437      -0.017922   [0.525078, 0.957759]
Sekundarstufe II     0.676088     0.706185      -0.036636   [0.486946, 0.935639]
Primarstufe          0.626790     0.651508      -0.081417   [0.402801, 0.911513]
Erwachsenenbildung   0.234320     0.193371      -0.041795  [0.0233272, 0.374059]
Hochschule           0.218753     0.181263      -0.005985  [0.0215196, 0.346661]
Berufliche Bildung   0.214703     0.174803      -0.003098  [0.0204237, 0.341684]
Elementarbereich     0.198640     0.158174      -0.005818     [0.0154, 0.313532]
Förderschule         0.195598     0.156192       0.008920  [0.0128674, 0.301224]
Fortbildung          0.192094     0.150680       0.001171  [0.0141191, 0.307079]
Fernunterricht       0.160673     0.122667       0.016400  [0.0111037, 0.252696]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff          prob_interval
name                                                                    
Lerner/in    0.752934     0.791352      -0.016014   [0.608254, 0.975578]
Lehrer/in    0.661824     0.692350       0.006979   [0.471526, 0.947653]
Eltern       0.337871     0.307867      -0.088876  [0.0565001, 0.537449]
Berater/in   0.197976     0.155842       0.012641  [0.0134351, 0.314242]
Verwaltung   0.196015     0.153482       0.024976  [0.0131685, 0.308818]
andere       0.173807     0.135894      -0.002520  [0.00647283, 0.27034]
Autor/in     0.169229     0.127804       0.011170  [0.00900113, 0.26638]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                            mean_prob  median_prob  baseline_diff          prob_interval
name                                                                                                    
Material                                     0.494830     0.493694       0.015620   [0.214668, 0.766339]
Audio                                        0.492031     0.488701      -0.133219   [0.225746, 0.769218]
Erklärvideo und gefilmtes Experiment         0.324926     0.293543      -0.023322  [0.0463179, 0.501536]
Arbeitsblatt                                 0.306063     0.273719       0.030377   [0.049172, 0.476998]
Unterrichtsbaustein                          0.305833     0.269857       0.046818  [0.0460638, 0.481492]
Webseite                                     0.266140     0.229615       0.035118  [0.0324343, 0.421245]
Tool                                         0.259316     0.222041       0.034520  [0.0323307, 0.413037]
Wiki (dynamisch)                             0.251289     0.215050       0.020571  [0.0269746, 0.391055]
Veranschaulichung, Schaubild und Tafelbild   0.248438     0.209940      -0.014676  [0.0287781, 0.393806]
Dokumente und textbasierte Inhalte           0.246971     0.209589       0.028626  [0.0281454, 0.386955]

properties.ccm:taxonid
--------------------------------------------------------------------
             mean_prob  median_prob  baseline_diff          prob_interval
name                                                                     
Allgemein     0.396499     0.378549       0.004626   [0.111541, 0.613149]
Geschichte    0.342125     0.313466      -0.054046  [0.0730377, 0.531806]
Politik       0.240825     0.203492      -0.027521  [0.0289133, 0.380435]
Philosophie   0.219530     0.179693       0.007052    [0.01906, 0.339271]
Mathematik    0.210942     0.172488       0.044409  [0.0192489, 0.330182]
Informatik    0.210424     0.170726       0.020227  [0.0160528, 0.331588]
Musik         0.208430     0.172518       0.008655  [0.0224436, 0.324174]
Physik        0.207147     0.170089       0.008043   [0.019511, 0.324677]
Ethik         0.201058     0.163569       0.001690  [0.0192095, 0.315143]
Französisch   0.200766     0.161475       0.017451  [0.0194203, 0.316107]
#+end_example

The individual probabilities of the categories do not add up to 1. This is intended, as assigning a text multiple relevant categories is often desired. As an example, take the following paragraph taken from [[https://de.wikipedia.org/wiki/Deutschland][the German Wikipedia page on Germany]]. This is mostly about the history of Germany, but because it also covers relatively recent developments, it may also be relevant to politics.
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "Die rasche Entwicklung vom Agrar- zum Industriestaat vollzog sich während der Gründerzeit in der zweiten Hälfte des 19. Jahrhunderts. Nach dem Ersten Weltkrieg wurde 1918 die Monarchie abgeschafft und die demokratische Weimarer Republik konstituiert. Ab 1933 führte die nationalsozialistische Diktatur zu politischer und rassistischer Verfolgung und gipfelte in der Ermordung von sechs Millionen Juden und Angehörigen anderer Minderheiten wie Sinti und Roma. Der vom NS-Staat 1939 begonnene Zweite Weltkrieg endete 1945 mit der Niederlage der Achsenmächte. Das von den Siegermächten besetzte Land wurde 1949 geteilt, nachdem bereits 1945 seine Ostgebiete teils unter polnische, teils sowjetische Verwaltungshoheit gestellt worden waren. Der Gründung der Bundesrepublik als demokratischer westdeutscher Teilstaat mit Westbindung am 23. Mai 1949 folgte die Gründung der sozialistischen DDR am 7. Oktober 1949 als ostdeutscher Teilstaat unter sowjetischer Hegemonie. Die innerdeutsche Grenze war nach dem Berliner Mauerbau (ab 13. August 1961) abgeriegelt. Nach der friedlichen Revolution in der DDR 1989 erfolgte die Lösung der deutschen Frage durch die Wiedervereinigung beider Landesteile am 3. Oktober 1990, womit auch die Außengrenzen Deutschlands als endgültig anerkannt wurden. Durch den Beitritt der fünf ostdeutschen Länder sowie die Wiedervereinigung von Ost- und West-Berlin zur heutigen Bundeshauptstadt zählt die Bundesrepublik Deutschland seit 1990 sechzehn Bundesländer.",
  "num_predictions": "7",
  "num_samples": "10000"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                                     mean_prob  median_prob  baseline_diff           prob_interval
name                                                                                              
Deutschland 1949 - 1990               0.237436     0.178577       0.033286  [0.00541161, 0.391151]
Personen in Deutschland 1949 - 1990   0.221714     0.159446       0.075966  [0.00228602, 0.370464]
Französisch                           0.217688     0.158828       0.005477  [0.00465832, 0.358526]
Mauerbau                              0.217196     0.160576       0.068419  [0.00700212, 0.367986]
Stadtgeschichte                       0.216826     0.156570       0.020607  [0.00636961, 0.353781]
Theatertheorie                        0.207945     0.150913       0.004178  [0.00367615, 0.343749]
Wie mache ich mich selbstständig?     0.204266     0.140838       0.046204  [0.00413338, 0.336873]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff          prob_interval
name                                                                            
Sekundarstufe II     0.732402     0.770342       0.019678   [0.576403, 0.970787]
Sekundarstufe I      0.718535     0.753103       0.007583   [0.557681, 0.964787]
Primarstufe          0.335138     0.301136      -0.373069  [0.0486429, 0.525802]
Berufliche Bildung   0.282061     0.246937       0.064260  [0.0376481, 0.444045]
Hochschule           0.245595     0.205802       0.020856  [0.0222047, 0.382608]
Erwachsenenbildung   0.224805     0.182538      -0.051310  [0.0176856, 0.355912]
Förderschule         0.175997     0.135734      -0.010681  [0.0125229, 0.273838]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff           prob_interval
name                                                                     
Lehrer/in    0.791122     0.833973       0.136277    [0.667808, 0.984961]
Lerner/in    0.640289     0.665962      -0.128658    [0.438498, 0.937086]
Eltern       0.293001     0.250675      -0.133747    [0.028768, 0.468309]
andere       0.179247     0.138946       0.002920   [0.0156401, 0.281423]
Autor/in     0.175320     0.135212       0.017261   [0.0117233, 0.276958]
Berater/in   0.166621     0.127291      -0.018714   [0.0112028, 0.260013]
Verwaltung   0.162821     0.123038      -0.008219  [0.00709056, 0.256205]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                     mean_prob  median_prob  baseline_diff          prob_interval
name                                                                             
Material              0.362391     0.340031      -0.116820  [0.0916652, 0.576057]
Audio                 0.321810     0.286534      -0.303440  [0.0416872, 0.501481]
Arbeitsblatt          0.282663     0.246539       0.006977  [0.0370915, 0.449493]
Wiki (dynamisch)      0.256602     0.216920       0.025885  [0.0288055, 0.407553]
Unterrichtsbaustein   0.243362     0.203290      -0.015653  [0.0234006, 0.383553]
Webseite              0.215618     0.179765      -0.015405  [0.0252201, 0.339473]
Unterrichtsplanung    0.213900     0.174716       0.068998  [0.0172594, 0.332998]

properties.ccm:taxonid
--------------------------------------------------------------------
                  mean_prob  median_prob  baseline_diff          prob_interval
name                                                                          
Geschichte         0.781901     0.826663       0.385730   [0.645203, 0.990638]
Politik            0.321861     0.288946       0.053515  [0.0490435, 0.499796]
Wirtschaftskunde   0.193712     0.154849       0.023341   [0.015008, 0.305223]
Allgemein          0.183424     0.146241      -0.208450   [0.0180867, 0.28763]
Religion           0.178398     0.141078      -0.018072  [0.0176087, 0.283057]
Geografie          0.178232     0.140934       0.004973  [0.0119878, 0.279556]
Pädagogik          0.177893     0.142467      -0.021468  [0.0163769, 0.281574]
#+end_example

* Notes / Limitations

** RAM Usage
The service requires roughly 4GB of RAM to operate. This usage should be roughly static with time, though queries will momentarily increase the RAM usage -- proportionally to the number of samples used.

** Cutoffs
Because of the nature of the model, it can be difficult to decide on which predictions shall be counted as actually being predicted to be assigned. Experimentally, a cutoff of around 0.3 for the mean probability for the school discipline and 0.4 for the educational context appear to be good metrics.

However, more investigations into better cutoffs, e.g. per-category, might be useful.

** Hierarchical Metadata
While the model can technically predict some hierarchical metadata (i.e. =oeh_lrt= and =curriculum=), these hierarchies are currently flattened, such that any information stemming from the hierarchies is discarded. This may be dealt with at a later date.

* Model Details and Possible Improvements

The model is based on the [[https://pyro.ai/examples/prodlda.html][example implementation]] of [[https://arxiv.org/abs/1703.01488][the ProdLDA model (arXiv:1703.01488)]] in [[https://pyro.ai/][Pyro]], utilizing black-box variational inference. We modified this unsupervised topic model by introducing a linear relationship between the assigned topic mixture and each category of each metadata field to be predicted. Individual categories between different metadata fields are modeled to be independent.

This could be improved in various ways in the future:
1. Dependencies between categories (within individual metadata fields and between them) could be modeled. This could improve performance, especially when doing classification on partially labeled data (e.g. some categories or whole metadata fields are already given).
2. The relationship between topic mixture and metadata field categories is drawn from a global, unchanging distribution. Similarly to the variational parameters of the topic mixture, this relationship could instead be drawn from a document-specific distribution through a neural network, thus increasing the expressiveness of the model.
3. Rather than using the (naive, if pre-processed) bag-of-words representations of documents, utilize modern vectorization methods instead (see [[https://dl.acm.org/doi/abs/10.1145/2911451.2911499][Topic Modeling for Short Texts with Auxiliary Word Embeddings]] or [[https://arxiv.org/abs/2403.03737][Probabilistic Topic Modelling with Transformer Representations]]).
   
* Installation (through ~Nix Flakes~)

Add this repository to your Flake inputs. This may look like this:
#+begin_src nix
{
  inputs = {
    its-jointprobability = {
      url = "github:openeduhub/its-jointprobability";
      # optional
      # can reduce the total size when installing the application, but may
      # cause problems due to breaking changes in some dependencies
      nixpkgs.follows = "nixpkgs"; 
    };
  };
}
#+end_src

** Standalone Application

The micro-service is provided both as a ~nixpkgs~ overlay and as an output (~packages.${system}.its-jointprobability~). Thus, it may be included through
#+begin_src nix
{
  outputs =
    {
      self,
      nixpkgs,
      its-jointprobability,
      ...
    }:
    let
      system = "x86_64-linux";
      pkgs = nixpkgs.legacyPackages.${system}.extend
        its-jointprobability.overlays.default;
    in
    { };
}
#+end_src

** Python Library

The Python library is also provided as an overlay. Please not that this requires a version of ~nixpkgs~ later than =02b8c7ddb7fe956871fa65466bf8a30fa69ec078=, from 2024-03-14 (i.e. =nixos-24.05= or later, or =nixpkgs-unstable= / =nixos-unstable=).
 
#+begin_src nix
{
  outputs =
    {
      self,
      nixpkgs,
      its-jointprobability,
      ...
    }:
    let
      system = "x86_64-linux";
      pkgs = nixpkgs.legacyPackages.${system}.extend
        its-jointprobability.overlays.python-lib;

      my-python = pkgs.python3.withPackages (
        py-pkgs: with py-pkgs; [
          # some examples
          pandas
          numpy
          # this library
          its-jointprobability
        ]
      );
    in
    { };
}
#+end_src

