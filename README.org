:PROPERTIES:
:header-args: :results verbatim :exports both
:END:
#+title: its-jointprobability
#+EXPORT_EXCLUDE_TAGS: noexport

A Bayesian approach to generating metadata for educational materials.

This project is primarily intended to be used as a microservice through the ~nix~ package. Additionally, it includes some CLI utilities in order to (re-) train the model for some data (data not included).

* Utils :noexport:
#+name: format-json
#+begin_src shell sh :var result="" :results verbatim
echo $result | json
#+end_src

#+name: format-prediction
#+begin_src python :var result="" :results output :session python-jointprobability-demo
import json
import pandas as pd
result_dict = json.loads(result)["predictions"]
for key, value in sorted(list(result_dict.items())):
    print(key)
    print("--------------------------------------------------------------------")
    df = pd.DataFrame.from_dict(value).set_index("name")
    df = df.drop("id", axis=1)
    df["prob_interval"] = df.apply(lambda x: [f"{y:g}" for y in x["prob_interval"]], axis=1)
    print(df.to_string())
    print()
#+end_src

* Usage

** Service

With ~Nix~, no further installation is required to run the microservice. Simply run the following command:
#+begin_src shell
nix run github:openeduhub/its-jointprobability
#+end_src
or optionally, with CUDA support:
#+begin_src shell
nix run "github:openeduhub/its-jointprobability#with-cuda"
#+end_src

If the package has been installed locally, the service is also available as ~its-jointprobability~ from the command line.

For more information on configuration options, see
#+begin_src shell
nix run github:openeduhub/its-jointprobability -- --help
#+end_src

Once started, see the ~Swagger~ UI for documentation on the service.
It is located on =http://localhost:8080/docs= by default.

** Model Training

To retrain the model under some data, use the included ~retrain-model~ CLI tool, e.g. through
#+begin_src shell
nix run "github:openeduhub/its-jointprobability#retrain-model" -- <path/to/data-dir>
#+end_src
or, *highly recommended*, with CUDA:
#+begin_src shell
nix run "github:openeduhub/its-jointprobability#retrain-model-with-cuda" -- <path/to/data-dir>
#+end_src

The utility will look for =train_data= and =train_labels=, which are assumed to files that can be loaded through [[https://pytorch.org/docs/stable/generated/torch.load.html][torch.load]]. These should be (=float=-type) [[https://pytorch.org/docs/stable/tensors.html#torch.Tensor][torch.Tensor]] objects with the following content:
- ~train_data_labeled~ :: a two-dimensional =Tensor= where the first dimension corresponds to the individual documents to use for training and the second dimensions contains each document's content, encoded through their Bag-of-words representation.
- ~train_targets~ :: a two-dimensional =Tensor= where the first dimension corresponds to the individual documents to use for training and the second dimension encodes whether each document belongs to each discipline (=1.0= if it does, =0.0= otherwise).

Once the data has been loaded, the topic model will be trained (this will take a long time) and saved within the set directory under =prodslda=. If this file already exists, this step is skipped.

Finally, the Bayesian classification model is trained and saved under =classification=. At this point, some quality metrics will be computed for the model on the training data. If ~test_data_labeled~ and ~test_targets~ are present in the given directory (analogous to the training data), these quality metrics will also be computed for this testing data.

** As a Python Library
:PROPERTIES:
:header-args: :session *python:its-jointprobability-demo* :results output :exports both :async yes
:END:

When doing larger scale analysis, using the model through a REST API may not be very convenient, especially because of the lack of proper parallelization of batches and thus much higher hardware utilization than would be possible.

For such use-cases, using the Python library directly is recommended. See [[Python Library]] for details on how to install the library through the provided ~nixpkgs~ overlay. Alternatively, using ~pip~ may also work.

*** For Inference

To load a pre-trained model, e.g. from https://gitlab.gwdg.de/jopitz/its-jointprobability-model, load the corresponding =ProdSLDA_{kwargs|pyro|state}.pt= files using ~its_jointprobability.data.load_model~:

#+begin_src python
from pathlib import Path
import torch
from its_jointprobability.models.prodslda import ProdSLDA
from its_jointprobability.data import load_model

model_path = Path("../its-jointprobability-model")
# use CUDA if it is available
device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model = load_model(ProdSLDA, model_path, device=device)

print(model)
#+end_src

#+RESULTS:
#+begin_example
ProdSLDA(
  (decoder): Sequential(
    (0): Linear(in_features=500, out_features=1000, bias=True)
    (1): Tanh()
    (2): Dropout(p=0.6, inplace=False)
    (3): Linear(in_features=1000, out_features=20918, bias=True)
    (4): BatchNorm1d(20918, eps=1e-05, momentum=0.1, affine=False, track_running_stats=True)
    (5): Softmax(dim=-1)
  )
  (encoder): Sequential(
    (0): Linear(in_features=20918, out_features=1000, bias=True)
    (1): Tanh()
    (2): Dropout(p=0.6, inplace=False)
    (3): Linear(in_features=1000, out_features=1000, bias=True)
    (4): BatchNorm1d(1000, eps=1e-05, momentum=0.1, affine=False, track_running_stats=True)
  )
)
#+end_example

Now, we can run inference on arbitrary texts by simply using the ~predict_from_texts~ method of the model:
#+begin_src python
texts = [
    "Der Satz des Pythagoras lautet: a^2 + b^2 = c^2",
    "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.",
]

predictions = list(
    model.predict_from_texts(*texts, tokens=model.vocab, num_samples=1000)
)
#+end_src

#+RESULTS:
: posterior sample: 100% 4/4 [00:03<00:00,  1.13it/s]
: posterior sample: 100% 19/19 [00:16<00:00,  1.18it/s]

#+begin_src python
from pprint import pprint

# print the most relevant predictions for the school discipline
print("Most relevant")
print("-------------")
for text, prediction in zip(texts, predictions):
    print(text)
    pprint(
        sorted(
            prediction["properties.ccm:taxonid"],
            key=lambda x: x.baseline_diff,
            reverse=True,
        )[:5]
    )
    print()
    
# print the least relevant predictions for the school discipline
print("Least relevant")
print("--------------")
for text, prediction in zip(texts, predictions):
    print(text)
    pprint(
        sorted(
            prediction["properties.ccm:taxonid"],
            key=lambda x: x.baseline_diff,
            reverse=False,
        )[:5]
    )
    print()
#+end_src

#+RESULTS:
#+begin_example
Most relevant
-------------
Der Satz des Pythagoras lautet: a^2 + b^2 = c^2
[Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/380', name='Mathematik', mean_prob=0.28282052278518677, median_prob=0.29025131464004517, baseline_diff=0.11789654195308685, prob_interval=(0.2267741560935974, 0.3414825201034546)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/20001', name='Englisch', mean_prob=0.2482297420501709, median_prob=0.25771528482437134, baseline_diff=0.04017959535121918, prob_interval=(0.16725067794322968, 0.2990630567073822)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/44099', name='Open Educational Resources', mean_prob=0.25054311752319336, median_prob=0.24403518438339233, baseline_diff=0.02842336893081665, prob_interval=(0.2193574458360672, 0.2815271019935608)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/680', name='Weiterbildung', mean_prob=0.2574133276939392, median_prob=0.2518172860145569, baseline_diff=0.02813813090324402, prob_interval=(0.19880801439285278, 0.3163970708847046)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/440', name='Pädagogik', mean_prob=0.2572174668312073, median_prob=0.2583962082862854, baseline_diff=0.02809588611125946, prob_interval=(0.21161530911922455, 0.2915562391281128))]

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
[Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/20001', name='Englisch', mean_prob=0.2610380947589874, median_prob=0.27437394857406616, baseline_diff=0.052987948060035706, prob_interval=(0.1407965123653412, 0.33423101902008057)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/20004', name='Italienisch', mean_prob=0.2737659811973572, median_prob=0.27451545000076294, baseline_diff=0.03827348351478577, prob_interval=(0.25373125076293945, 0.29020899534225464)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/20002', name='Französisch', mean_prob=0.2761891782283783, median_prob=0.2715223729610443, baseline_diff=0.036095112562179565, prob_interval=(0.24450698494911194, 0.3117305636405945)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/440', name='Pädagogik', mean_prob=0.2647663950920105, median_prob=0.25231263041496277, baseline_diff=0.03564481437206268, prob_interval=(0.20828121900558472, 0.31480568647384644)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/680', name='Weiterbildung', mean_prob=0.26256468892097473, median_prob=0.25764989852905273, baseline_diff=0.03328949213027954, prob_interval=(0.18275383114814758, 0.3443722128868103))]

Least relevant
--------------
Der Satz des Pythagoras lautet: a^2 + b^2 = c^2
[Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/240', name='Geschichte', mean_prob=0.3403876721858978, median_prob=0.3290773332118988, baseline_diff=-0.09274864196777344, prob_interval=(0.2901724576950073, 0.3977483808994293)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/720', name='Allgemein', mean_prob=0.40386316180229187, median_prob=0.4180868864059448, baseline_diff=-0.07408538460731506, prob_interval=(0.3315369486808777, 0.44830596446990967)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/420', name='Musik', mean_prob=0.20501786470413208, median_prob=0.2016226351261139, baseline_diff=-0.06278759241104126, prob_interval=(0.17343656718730927, 0.23350165784358978)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/04013', name='Wirtschaft und Verwaltung', mean_prob=0.17665861546993256, median_prob=0.17149583995342255, baseline_diff=-0.05680166184902191, prob_interval=(0.15863868594169617, 0.1978340595960617)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/600', name='Sport', mean_prob=0.20631062984466553, median_prob=0.20855283737182617, baseline_diff=-0.05453494191169739, prob_interval=(0.18447235226631165, 0.23205740749835968))]

Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.
[Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/04013', name='Wirtschaft und Verwaltung', mean_prob=0.17270974814891815, median_prob=0.17175129055976868, baseline_diff=-0.060750529170036316, prob_interval=(0.15859352052211761, 0.19493801891803741)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/600', name='Sport', mean_prob=0.20194239914417267, median_prob=0.20145858824253082, baseline_diff=-0.05890317261219025, prob_interval=(0.17810368537902832, 0.22578197717666626)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/420', name='Musik', mean_prob=0.21323584020137787, median_prob=0.20875051617622375, baseline_diff=-0.05456961691379547, prob_interval=(0.16602002084255219, 0.258750855922699)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/48005', name='Gesellschaftskunde', mean_prob=0.178267240524292, median_prob=0.1770876795053482, baseline_diff=-0.04625558853149414, prob_interval=(0.11942555755376816, 0.23770105838775635)),
 Prediction_Score(id='http://w3id.org/openeduhub/vocabs/discipline/72001', name='Zeitgemäße Bildung', mean_prob=0.21165725588798523, median_prob=0.2218230962753296, baseline_diff=-0.037673160433769226, prob_interval=(0.1574438214302063, 0.24163922667503357))]
#+end_example

* REST API
:PROPERTIES:
:header-args: :results verbatim :exports both :post format-json(result=*this*) :wrap src
:END:

** Ping

Once the service has started, we can ping it to check that it is responding to requests:
#+begin_src shell :post :exports both
curl -i -X GET http://localhost:8080/_ping
#+end_src

#+RESULTS:
#+begin_src
HTTP/1.1 200 OK
date: Mon, 15 Jan 2024 15:34:05 GMT
server: uvicorn
content-length: 4
content-type: application/json

null
#+end_src

** Predictions
:PROPERTIES:
:header-args: :results verbatim :exports both :post format-prediction(result=*this*)
:END:

With the =/predict= endpoint, we can send a text to the model. For readability, we only ask for the seven most relevant categories for each metadata field.

In addition to the identifiers of the predicted metadata, we also get some diagnostics that help us understand whether this is a relevant match (in principle, all categories are always returned). Specifically, we gain two point-estimates (mean and median) for the probability of the category belonging to the given text, according to the model. We also get the difference to the "baseline" (i.e. an empty text) and a credibility interval (by default 80%) on said probability.

In the example below, we get only one relevant school discipline, which is also the one we would be expecting for the text (Mathematics). Because the text is relatively short, the probability of this fit is still relatively low. We also get a strong match *against* primary school (indicated by the large negative difference to the baseline probability), which is also what we would expect, given that Pythagoras' Theorem is usually covered in middle school and above.
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "Der Satz des Pythagoras lautet: a^2 + b^2 = c^2. Er wird benutzt, um die Hypotenuse eines rechtwinkligen Dreiecks zu berechnen.",
  "num_predictions": "7"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                                  mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                         
Preisbildung                       0.489821     0.489542       0.257999  [0.424084, 0.550186]
Richtig schreiben                  0.424102     0.424029       0.210275    [0.3687, 0.466378]
Ökologische Landwirtschaft         0.414800     0.412063       0.183786  [0.352617, 0.468079]
Außerschulisches Lernen            0.407475     0.407176       0.166746  [0.358063, 0.471739]
Krankheiten                        0.401831     0.401045       0.200384  [0.351796, 0.464552]
ethische Konflikte der Gegenwart   0.393692     0.389787       0.142046  [0.328125, 0.465392]
Diskurse in der Kunst              0.384317     0.381894       0.095191  [0.327785, 0.436705]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff         prob_interval
name                                                                           
Sekundarstufe II     0.555055     0.554944      -0.140459  [0.526243, 0.589686]
Sekundarstufe I      0.549674     0.553704      -0.108107  [0.503934, 0.598932]
Primarstufe          0.318400     0.318588      -0.363561  [0.290558, 0.355763]
Erwachsenenbildung   0.276270     0.275531      -0.044023  [0.251193, 0.296746]
Fernunterricht       0.248015     0.247615       0.016149  [0.224118, 0.266134]
Elementarbereich     0.247658     0.247210      -0.000322  [0.222202, 0.265148]
Hochschule           0.245089     0.244381      -0.055499   [0.226079, 0.26758]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff         prob_interval
name                                                                   
Lerner/in    0.735736     0.736186       0.001095  [0.713765, 0.763556]
Lehrer/in    0.597869     0.598450      -0.032788  [0.566519, 0.634596]
Verwaltung   0.281725     0.280507       0.036992  [0.257233, 0.300419]
Eltern       0.266660     0.265114      -0.171616  [0.239527, 0.285504]
Berater/in   0.241741     0.241554       0.015850  [0.225679, 0.256058]
andere       0.233778     0.233377       0.009906  [0.214649, 0.247599]
Autor/in     0.209114     0.208964      -0.032341  [0.190716, 0.224172]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                                        mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                                               
Arbeitsblatt                                             0.447228     0.447419       0.170717  [0.397983, 0.500775]
Erklärvideo und gefilmtes Experiment                     0.419925     0.412891       0.050776  [0.366492, 0.459172]
Material                                                 0.337402     0.337638      -0.194485  [0.301299, 0.372481]
Video (Material)                                         0.298606     0.299009       0.147838    [0.26422, 0.32626]
Tool                                                     0.297438     0.294776       0.000245  [0.268401, 0.328572]
offene und kreative Aktivität (Lehr- und Lernmaterial)   0.292557     0.290036       0.018237  [0.258893, 0.317276]
Wiki (dynamisch)                                         0.292367     0.290385       0.013252  [0.266124, 0.323157]

properties.ccm:taxonid
--------------------------------------------------------------------
                   mean_prob  median_prob  baseline_diff         prob_interval
name                                                                          
Mathematik          0.574288     0.574829       0.396791  [0.522374, 0.621542]
Allgemein           0.301073     0.300259      -0.168936  [0.275786, 0.323209]
Sonderpädagogik     0.272097     0.272143       0.042885  [0.253707, 0.285183]
Chemie              0.265011     0.264337       0.002272  [0.245247, 0.284242]
Informatik          0.261745     0.260497       0.009107  [0.244862, 0.277861]
Medienbildung       0.260692     0.260160       0.021015   [0.24432, 0.275396]
Arbeitssicherheit   0.260176     0.259774       0.009743  [0.239068, 0.276898]
#+end_example

Note that these predictions are stochastic, so another run on the same text may yield slightly different predictions:
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "Der Satz des Pythagoras lautet: a^2 + b^2 = c^2. Er wird benutzt, um die Hypotenuse eines rechtwinkligen Dreiecks zu berechnen.",
  "num_predictions": "7"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                              mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                     
Altsteinzeit                   0.454203     0.451802       0.250157   [0.38475, 0.511222]
Design                         0.440322     0.438752       0.229017   [0.372466, 0.48731]
Französisch                    0.434703     0.433178       0.226882  [0.364081, 0.487152]
Gamification                   0.428076     0.427190       0.252934  [0.365166, 0.483754]
Zusammenarbeiten und Teilen    0.410357     0.406848       0.180772  [0.344627, 0.472978]
Säuren und Basen               0.397139     0.395000       0.169943  [0.343495, 0.451713]
Chemie                         0.396660     0.393978       0.157692  [0.338291, 0.448692]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff         prob_interval
name                                                                           
Sekundarstufe I      0.566683     0.567538      -0.091098  [0.533449, 0.602615]
Sekundarstufe II     0.532656     0.533315      -0.162857  [0.485909, 0.583094]
Primarstufe          0.310884     0.311477      -0.371077  [0.279569, 0.341278]
Erwachsenenbildung   0.296316     0.295997      -0.023977  [0.270741, 0.321297]
Hochschule           0.237964     0.237166      -0.062624  [0.219247, 0.256544]
Berufliche Bildung   0.223772     0.223204      -0.035507  [0.205593, 0.237798]
Förderschule         0.202061     0.201409      -0.035017  [0.181149, 0.226863]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff         prob_interval
name                                                                   
Lerner/in    0.752657     0.753159       0.018016  [0.730799, 0.773489]
Lehrer/in    0.604023     0.605483      -0.026634  [0.567919, 0.637378]
Eltern       0.295721     0.295189      -0.142555  [0.276282, 0.318502]
andere       0.235576     0.235447       0.011704  [0.220436, 0.249319]
Autor/in     0.221978     0.222034      -0.019477  [0.208012, 0.237268]
Verwaltung   0.194937     0.194881      -0.049796  [0.181939, 0.207155]
Berater/in   0.190752     0.191426      -0.035140  [0.173111, 0.206801]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                                        mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                                               
Arbeitsblatt                                             0.456616     0.455364       0.180106  [0.416737, 0.510177]
Material                                                 0.339023     0.338270      -0.192864  [0.304625, 0.373471]
Erklärvideo und gefilmtes Experiment                     0.326170     0.320688      -0.042980  [0.270044, 0.359816]
offene und kreative Aktivität (Lehr- und Lernmaterial)   0.302130     0.300771       0.027809  [0.272408, 0.328997]
Übungsmaterial                                           0.300129     0.299058       0.053946  [0.274554, 0.322066]
Tool                                                     0.291849     0.291366      -0.005345   [0.260236, 0.31267]
Dokumente und textbasierte Inhalte                       0.291496     0.290558       0.008229    [0.266766, 0.3207]

properties.ccm:taxonid
--------------------------------------------------------------------
                              mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                     
Mathematik                     0.722688     0.722066       0.545191  [0.675976, 0.765599]
Allgemein                      0.280010     0.279605      -0.189999  [0.257456, 0.295868]
Arbeitssicherheit              0.275019     0.275026       0.024586  [0.257996, 0.293948]
Elektrotechnik                 0.264623     0.263676       0.035306  [0.244433, 0.282503]
Geschichte                     0.260085     0.258164      -0.161308  [0.234839, 0.281156]
Ernährung und Hauswirtschaft   0.259248     0.258862       0.013780   [0.24146, 0.273458]
Hauswirtschaft                 0.251852     0.251273       0.007026  [0.237784, 0.263988]
#+end_example

To reduce this variance, we can increase the number of samples being drawn for the prediction. Note that the computation time is roughly proportional to the number of such samples. By default, 500 samples are drawn.
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "Der Satz des Pythagoras lautet: a^2 + b^2 = c^2. Er wird benutzt, um die Hypotenuse eines rechtwinkligen Dreiecks zu berechnen.",
  "num_predictions": "7",
  "num_samples": "10000"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                           mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                  
Satzgruppe des Pythagoras   0.270756     0.260947       0.052121  [0.155441, 0.356534]
Sprachmittlung              0.267651     0.260440       0.010712  [0.119599, 0.356349]
Projektideen                0.263278     0.247765       0.012016  [0.121626, 0.375252]
Das Teilchenmodell          0.251056     0.241055       0.059003  [0.111562, 0.353089]
Mobilität und Verkehr       0.247750     0.232286       0.037994  [0.103851, 0.329081]
Digitalisierung             0.245837     0.223576       0.050548  [0.135648, 0.312082]
Spanisch                    0.245003     0.228039       0.014866  [0.124221, 0.375113]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff         prob_interval
name                                                                           
Sekundarstufe I      0.625202     0.622178      -0.032579  [0.564857, 0.681186]
Sekundarstufe II     0.579109     0.588047      -0.116404  [0.520954, 0.663581]
Primarstufe          0.314904     0.307002      -0.367057  [0.242729, 0.381315]
Erwachsenenbildung   0.282197     0.285341      -0.038096  [0.226471, 0.335219]
Hochschule           0.254033     0.257266      -0.046556   [0.196389, 0.31654]
Berufliche Bildung   0.232874     0.229052      -0.026405  [0.176408, 0.282003]
Förderschule         0.224673     0.224201      -0.012404  [0.179809, 0.270445]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff         prob_interval
name                                                                   
Lerner/in    0.774423     0.773733       0.039782  [0.736249, 0.815625]
Lehrer/in    0.639231     0.642746       0.008574  [0.590204, 0.704476]
Eltern       0.280304     0.277030      -0.157972  [0.231777, 0.320417]
Berater/in   0.234697     0.232737       0.008805  [0.191403, 0.278496]
andere       0.219643     0.216229      -0.004229  [0.167829, 0.264495]
Autor/in     0.213244     0.209289      -0.028211  [0.164659, 0.251146]
Verwaltung   0.211793     0.215763      -0.032940  [0.154473, 0.256069]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                      mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                             
Arbeitsblatt                           0.460401     0.457908       0.183890  [0.398005, 0.522478]
Material                               0.359839     0.359794      -0.172048  [0.305273, 0.411568]
Erklärvideo und gefilmtes Experiment   0.353707     0.349222      -0.015443  [0.293882, 0.404937]
Übungsmaterial                         0.301042     0.297789       0.054859  [0.258083, 0.336815]
Unterrichtsbaustein                    0.287840     0.288074      -0.068469  [0.247839, 0.329709]
Wiki (dynamisch)                       0.286130     0.285874       0.007015  [0.239123, 0.330791]
Tool                                   0.284418     0.282540      -0.012775  [0.239728, 0.318528]

properties.ccm:taxonid
--------------------------------------------------------------------
                     mean_prob  median_prob  baseline_diff         prob_interval
name                                                                            
Mathematik            0.643223     0.640263       0.465726  [0.579129, 0.700501]
Allgemein             0.269530     0.273247      -0.200479  [0.221187, 0.311655]
Physik                0.259097     0.258505       0.015485  [0.216459, 0.299352]
Geschichte            0.252734     0.250778      -0.168658  [0.211328, 0.285962]
Informatik            0.246673     0.244264      -0.005965  [0.210759, 0.273358]
Chemie                0.235414     0.238755      -0.027326  [0.199336, 0.283557]
Darstellendes Spiel   0.232207     0.232626       0.003962  [0.199099, 0.280505]
#+end_example

Second run, for comparison
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "Der Satz des Pythagoras lautet: a^2 + b^2 = c^2. Er wird benutzt, um die Hypotenuse eines rechtwinkligen Dreiecks zu berechnen.",
  "num_predictions": "7",
  "num_samples": "10000"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                              mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                     
Skalarprodukt                  0.278165     0.268065       0.079395  [0.167948, 0.372595]
Analytische Geometrie          0.264636     0.245643       0.009924   [0.13601, 0.342652]
Musik                          0.248616     0.242891       0.023867  [0.154563, 0.319701]
Rechengesetze                  0.247178     0.225514       0.032360  [0.114345, 0.358171]
Die Ionenbindung               0.242020     0.238857       0.010435  [0.111838, 0.325086]
Säuren und Basen               0.240919     0.231036       0.013723  [0.151555, 0.345378]
Produzieren und Präsentieren   0.240726     0.242817       0.033061  [0.115987, 0.319782]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff         prob_interval
name                                                                           
Sekundarstufe I      0.636087     0.643785      -0.021694  [0.572873, 0.703462]
Sekundarstufe II     0.582960     0.587183      -0.112554  [0.515522, 0.649003]
Primarstufe          0.294971     0.290724      -0.386990  [0.228691, 0.349155]
Erwachsenenbildung   0.263862     0.257868      -0.056431   [0.201452, 0.31002]
Hochschule           0.250526     0.247974      -0.050062  [0.201563, 0.281573]
Förderschule         0.233944     0.243695      -0.003134   [0.179916, 0.29541]
Berufliche Bildung   0.227088     0.224190      -0.032191   [0.167913, 0.27495]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff         prob_interval
name                                                                   
Lerner/in    0.773644     0.776746       0.039003    [0.73702, 0.81874]
Lehrer/in    0.643421     0.642072       0.012764   [0.590283, 0.69003]
Eltern       0.283819     0.283213      -0.154457   [0.233938, 0.32382]
andere       0.223681     0.225558      -0.000191  [0.187295, 0.259691]
Berater/in   0.215527     0.213450      -0.010364  [0.184089, 0.252744]
Autor/in     0.214196     0.210772      -0.027259  [0.170976, 0.243955]
Verwaltung   0.205361     0.203967      -0.039372  [0.175161, 0.239068]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                      mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                             
Arbeitsblatt                           0.469477     0.466756       0.192966  [0.388555, 0.536864]
Material                               0.349370     0.347674      -0.182517  [0.296586, 0.393632]
Erklärvideo und gefilmtes Experiment   0.348608     0.345388      -0.020541   [0.284922, 0.40129]
Übungsmaterial                         0.300800     0.299806       0.054617  [0.249993, 0.347737]
Wiki (dynamisch)                       0.288580     0.285930       0.009466  [0.236718, 0.334854]
Unterrichtsbaustein                    0.287705     0.289429      -0.068604  [0.249992, 0.329837]
Tool                                   0.279147     0.276378      -0.018046  [0.231906, 0.322225]

properties.ccm:taxonid
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff         prob_interval
name                                                                   
Mathematik   0.637744     0.637025       0.460247   [0.57303, 0.704038]
Allgemein    0.271259     0.268117      -0.198750  [0.222009, 0.315038]
Physik       0.255180     0.258764       0.011568  [0.211118, 0.295114]
Geschichte   0.253925     0.249062      -0.167468   [0.20799, 0.292168]
Informatik   0.251138     0.245300      -0.001500  [0.195742, 0.293498]
Chemie       0.243827     0.243203      -0.018912  [0.206217, 0.287297]
Spanisch     0.243012     0.240667       0.003627  [0.206472, 0.276023]
#+end_example

You may notice that the probabilities for other, less fitting, categories, are still relatively high. This is because the text is relatively short, so the model cannot conclude that e.g. a particular school discipline does not fit. This behavior becomes more extreme the shorter the given text is. Essentially, the model has been given too little data to decide for or against any one category. This can also be seen in low differences to the baseline probabilities and large credibility interval.

For an even more extreme example, see the following, empty text, which corresponds to the baseline, when no information is given.
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "",
  "num_predictions": "10",
  "num_samples": "10000"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                                            mean_prob  median_prob  baseline_diff          prob_interval
name                                                                                                    
Strategien im Kunstunterricht                0.327673     0.344425       0.084452   [0.169013, 0.488133]
Exponential- und Logarithmusfunktion         0.303253     0.294092       0.056297   [0.215683, 0.413593]
Historische Entwicklung                      0.299850     0.307963       0.059714   [0.183728, 0.416184]
Induktion                                    0.296459     0.278213       0.054990   [0.137169, 0.402568]
Informationen, Nachrichten & Kommunikation   0.288748     0.266272       0.083611   [0.139129, 0.347421]
Gebrochenrationale Funktionen                0.284290     0.298259       0.073079   [0.142417, 0.435838]
Grundfragen                                  0.283402     0.257200       0.089498   [0.138944, 0.391146]
Peripherie                                   0.283298     0.275582       0.083789     [0.1641, 0.389656]
Migration und Flucht                         0.282827     0.272487       0.044644   [0.185288, 0.420695]
Dramatische Texte                            0.281395     0.267810       0.035941  [0.0917086, 0.381411]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff         prob_interval
name                                                                           
Sekundarstufe II     0.713137     0.710398       0.017624  [0.673053, 0.768352]
Sekundarstufe I      0.651987     0.645402      -0.005795  [0.559879, 0.715286]
Primarstufe          0.645795     0.660623      -0.036166  [0.578604, 0.749837]
Hochschule           0.319442     0.308161       0.018854  [0.234934, 0.418429]
Erwachsenenbildung   0.315678     0.324600      -0.004616   [0.242272, 0.37533]
Berufliche Bildung   0.265268     0.266019       0.005988  [0.216649, 0.336818]
Elementarbereich     0.257199     0.257185       0.009219  [0.209494, 0.328873]
Fernunterricht       0.223858     0.214927      -0.008007  [0.146109, 0.283754]
Förderschule         0.222908     0.215985      -0.014169  [0.166808, 0.280759]
Fortbildung          0.220525     0.215086      -0.017451  [0.133371, 0.246738]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff         prob_interval
name                                                                   
Lerner/in    0.745887     0.739780       0.011246  [0.678667, 0.801515]
Lehrer/in    0.624076     0.614908      -0.006581   [0.474138, 0.72606]
Eltern       0.421051     0.432408      -0.017225  [0.340438, 0.500934]
Verwaltung   0.255772     0.250484       0.011039  [0.166431, 0.317625]
Berater/in   0.240020     0.235322       0.014128  [0.173739, 0.302563]
andere       0.236675     0.233309       0.012803  [0.176577, 0.283687]
Autor/in     0.220980     0.204912      -0.020475  [0.129363, 0.288075]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                                        mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                                               
Audio                                                    0.583611     0.579005       0.001037   [0.52706, 0.663697]
Material                                                 0.536147     0.538671       0.004260  [0.478904, 0.602777]
Erklärvideo und gefilmtes Experiment                     0.344935     0.348295      -0.024215  [0.250866, 0.397149]
Unterrichtsbaustein                                      0.342171     0.331647      -0.014138  [0.281522, 0.398746]
Kurs                                                     0.325240     0.319612       0.023955  [0.255894, 0.387631]
Webseite                                                 0.296744     0.294325      -0.002168  [0.205926, 0.365267]
Tool                                                     0.296392     0.289931      -0.000801   [0.18816, 0.348668]
Wiki (dynamisch)                                         0.284714     0.291834       0.005600   [0.221914, 0.39314]
Veranschaulichung, Schaubild und Tafelbild               0.284385     0.255634      -0.040581  [0.222226, 0.349615]
offene und kreative Aktivität (Lehr- und Lernmaterial)   0.277523     0.274386       0.003203  [0.195041, 0.323992]

properties.ccm:taxonid
--------------------------------------------------------------------
             mean_prob  median_prob  baseline_diff         prob_interval
name                                                                    
Allgemein     0.469581     0.463049      -0.000428   [0.406142, 0.53214]
Geschichte    0.448224     0.454454       0.026831  [0.380908, 0.528827]
Philosophie   0.273625     0.269383       0.013033  [0.209169, 0.308513]
Musik         0.271804     0.268332       0.005011   [0.20899, 0.318537]
Politik       0.270191     0.268260       0.008084  [0.176835, 0.320988]
Religion      0.262444     0.259891      -0.001933   [0.194484, 0.30972]
Biologie      0.261615     0.258530       0.022088   [0.202766, 0.29291]
Ethik         0.260802     0.258781       0.010390   [0.176608, 0.31696]
Chemie        0.259847     0.249125      -0.002893   [0.21993, 0.309653]
Physik        0.256046     0.261711       0.012434   [0.190595, 0.32602]
#+end_example

The individual probabilities of the categories do not add up to 1. This is intended, as assigning a text multiple relevant categories is often desired. As an example, take the following paragraph taken from [[https://de.wikipedia.org/wiki/Deutschland][the German Wikipedia page on Germany]]. This is mostly about the history of Germany, but because it also covers relatively recent developments, it may also be relevant to politics.
#+begin_src shell :exports both
curl -X 'POST' \
  'http://localhost:8080/predict' \
  -H 'Content-Type: application/json' \
  -d '{
  "text": "Die rasche Entwicklung vom Agrar- zum Industriestaat vollzog sich während der Gründerzeit in der zweiten Hälfte des 19. Jahrhunderts. Nach dem Ersten Weltkrieg wurde 1918 die Monarchie abgeschafft und die demokratische Weimarer Republik konstituiert. Ab 1933 führte die nationalsozialistische Diktatur zu politischer und rassistischer Verfolgung und gipfelte in der Ermordung von sechs Millionen Juden und Angehörigen anderer Minderheiten wie Sinti und Roma. Der vom NS-Staat 1939 begonnene Zweite Weltkrieg endete 1945 mit der Niederlage der Achsenmächte. Das von den Siegermächten besetzte Land wurde 1949 geteilt, nachdem bereits 1945 seine Ostgebiete teils unter polnische, teils sowjetische Verwaltungshoheit gestellt worden waren. Der Gründung der Bundesrepublik als demokratischer westdeutscher Teilstaat mit Westbindung am 23. Mai 1949 folgte die Gründung der sozialistischen DDR am 7. Oktober 1949 als ostdeutscher Teilstaat unter sowjetischer Hegemonie. Die innerdeutsche Grenze war nach dem Berliner Mauerbau (ab 13. August 1961) abgeriegelt. Nach der friedlichen Revolution in der DDR 1989 erfolgte die Lösung der deutschen Frage durch die Wiedervereinigung beider Landesteile am 3. Oktober 1990, womit auch die Außengrenzen Deutschlands als endgültig anerkannt wurden. Durch den Beitritt der fünf ostdeutschen Länder sowie die Wiedervereinigung von Ost- und West-Berlin zur heutigen Bundeshauptstadt zählt die Bundesrepublik Deutschland seit 1990 sechzehn Bundesländer.",
  "num_predictions": "7",
  "num_samples": "10000"
}'
#+end_src

#+RESULTS:
#+begin_example
properties.ccm:curriculum
--------------------------------------------------------------------
                                     mean_prob  median_prob  baseline_diff          prob_interval
name                                                                                             
Französische Revolution               0.269264     0.237232       0.018534   [0.107828, 0.352018]
Landeskunde und Interkulturelles      0.257001     0.241990       0.035878   [0.118345, 0.356457]
Geschichte                            0.255886     0.246351       0.037051    [0.11463, 0.366356]
Deutschland 1949 - 1990               0.254794     0.242090       0.058775   [0.123051, 0.358416]
Karl der Große                        0.251117     0.232272       0.045215   [0.132666, 0.335485]
Russland                              0.250358     0.239268       0.038870   [0.118617, 0.351917]
Personen in Deutschland 1949 - 1990   0.248852     0.217648       0.030437  [0.0952885, 0.356932]

properties.ccm:educationalcontext
--------------------------------------------------------------------
                    mean_prob  median_prob  baseline_diff         prob_interval
name                                                                           
Sekundarstufe II     0.683752     0.685653      -0.011761  [0.622202, 0.755971]
Sekundarstufe I      0.654843     0.660472      -0.002938  [0.574172, 0.753434]
Berufliche Bildung   0.294706     0.289775       0.035427  [0.229529, 0.349299]
Primarstufe          0.292112     0.287691      -0.389849  [0.215178, 0.361424]
Hochschule           0.263576     0.259940      -0.037012  [0.193491, 0.320421]
Erwachsenenbildung   0.235211     0.232329      -0.085082  [0.171049, 0.291656]
Fortbildung          0.225039     0.220044      -0.012936   [0.156637, 0.26801]

properties.ccm:educationalintendedenduserrole
--------------------------------------------------------------------
            mean_prob  median_prob  baseline_diff         prob_interval
name                                                                   
Lehrer/in    0.768977     0.773647       0.138320  [0.719517, 0.823311]
Lerner/in    0.599261     0.599985      -0.135380  [0.514642, 0.681179]
Eltern       0.284803     0.279889      -0.153473  [0.214966, 0.338453]
Berater/in   0.205375     0.201710      -0.020516  [0.133257, 0.261058]
Autor/in     0.201964     0.198114      -0.039492  [0.150169, 0.246424]
Verwaltung   0.196921     0.195342      -0.047812  [0.122687, 0.249148]
andere       0.192395     0.192518      -0.031477   [0.142936, 0.24118]

properties.ccm:oeh_lrt
--------------------------------------------------------------------
                                  mean_prob  median_prob  baseline_diff         prob_interval
name                                                                                         
Material                           0.354838     0.352450      -0.177049  [0.288011, 0.423948]
Arbeitsblatt                       0.313987     0.313862       0.037476  [0.229069, 0.395627]
Audio                              0.313899     0.311400      -0.268675  [0.247613, 0.373292]
Video (Material)                   0.281578     0.279943       0.130810  [0.204963, 0.352198]
Wiki (dynamisch)                   0.274774     0.268152      -0.004340  [0.206766, 0.332358]
Skript, Handout und Handreichung   0.264527     0.262295       0.046352  [0.204089, 0.315776]
Unterrichtsplanung                 0.262297     0.258843       0.069541  [0.207775, 0.310574]

properties.ccm:taxonid
--------------------------------------------------------------------
                  mean_prob  median_prob  baseline_diff         prob_interval
name                                                                         
Geschichte         0.713393     0.714186       0.292000   [0.618436, 0.82262]
Politik            0.383455     0.376613       0.121349   [0.299893, 0.45278]
Wirtschaftskunde   0.240499     0.239019       0.029480  [0.197482, 0.286573]
Sozialpädagogik    0.236327     0.235641       0.037851  [0.195155, 0.271667]
Sachunterricht     0.232697     0.228609       0.024848  [0.174097, 0.279125]
Religion           0.231874     0.232319      -0.032504  [0.176018, 0.285485]
Geografie          0.226799     0.222529       0.016992   [0.17827, 0.263993]
#+end_example

* Notes / Limitations

** RAM Usage
The service requires roughly 4GB of RAM to operate. This usage should be roughly static with time, though queries will momentarily increase the RAM usage -- proportionally to the number of samples used (up to a maximum, when batching kicks in).

** Cutoffs & Interpretation of Results
Because of the nature of the model, it can be difficult to decide on which predictions shall be counted as actually being predicted to be assigned. This is especially true for categories where a very large or small amount of data points where observed, as the model will essentially replicate these biases in the data. This is why we additionally provide the difference in means to the baseline probabilities (i.e. predictions where the text is empty) -- a larger difference, both positive and negative, indicates a stronger prediction, regardless of the underlying base frequencies. However, a lower difference in means to the baseline may also be a very certain prediction that just so happens to be around the baseline, which is why it can also be helpful to consider the probability credibility interval -- a narrower interval indicates higher certainty, whereas a wider one indicates lower certainty.

** Hierarchical Metadata
While the model can technically predict some hierarchical metadata (i.e. =oeh_lrt= and =curriculum=), these hierarchies are currently flattened, such that any information stemming from the hierarchies is discarded. This may be dealt with at a later date.

* Model Details and Possible Improvements

The model is based on the [[https://pyro.ai/examples/prodlda.html][example implementation]] of [[https://arxiv.org/abs/1703.01488][the ProdLDA model (arXiv:1703.01488)]] in [[https://pyro.ai/][Pyro]], utilizing black-box variational inference. We modified this unsupervised topic model by introducing a linear relationship between the assigned topic mixture and each category of each metadata field to be predicted. Individual categories between different metadata fields are modeled to be independent.

This could be improved in various ways in the future:
1. More topics and larger neural networks. Due to the large size of the newest training data, it may be beneficial to increase the current choice of 500 topics and shallow neural networks with a hidden layer size of 1000, e.g. doubling both or adding additional hidden layers to the encoder.
2. Dependencies between categories (within individual metadata fields and between them) could be modeled. This could improve performance, especially when doing classification on partially labeled data (e.g. some categories or whole metadata fields are already given).
3. The relationship between topic mixture and metadata field categories is drawn from a global, unchanging distribution. Similarly to the variational parameters of the topic mixture, this relationship could instead be drawn from a document-specific distribution through a neural network, thus increasing the expressiveness of the model.
   - Additionally, it may be worthwhile to also try "inverting" the relationship between topics and targets, i.e. draw targets based on document content first, then draw topics based on targets and document content. This could result in more stable prediction results, as the quality of predicted targets are no longer as closely linked to the quality of the predicted topics.
4. The number of topics to be estimated is currently a fixed hyper-parameter. Using a non-parametric hierarchical Dirichlet process (HDP) model instead would allow for a data-specific choice of the number of topics.
5. Introduce information about the hierarchies of the categories, where relevant (currently learning resource type and topic). This should result in more specificity in the predictions and better quality in general. Possibly relevant for this: [[https://dl.acm.org/doi/10.5555/2986459.2986750][Hierarchically supervised latent Dirichlet allocation]].
6. Rather than using the (naive, if pre-processed) bag-of-words representations of documents, utilize modern vectorization methods instead (see [[https://dl.acm.org/doi/abs/10.1145/2911451.2911499][Topic Modeling for Short Texts with Auxiliary Word Embeddings]] or [[https://arxiv.org/abs/2403.03737][Probabilistic Topic Modelling with Transformer Representations]]).
7. Utilize additional metadata for classification, e.g. the mimetype or source.
8. Utilize the metadata that is assigned to the collections, such as their school discipline or educational context.
9. Because predictions of probabilistic models are not just points, but rather a whole probability distribution over the entire probability space, we are currently "throwing away" a lot of potential information. It might be interesting, for example, to visualize the entire distribution over each metadatum's categories, in order to convey the certainty of predictions (a "broader" distribution shape implies less certainty, a "sharper" distribution more).
10. We currently use Python's builtin ~pickle~ for saving / exporting model parameters. Loading these files is generally considered to be unsafe, as they could execute arbitrary Python code. An alternative could be [[https://github.com/huggingface/safetensors][safetensors]].
11. Texts given processed through the REST-API do not run through the same pre-processing pipeline as the training data (repeated tokens are not removed, for example). Instead, they are simply tokenized and filtered according to the set of tokens in the training data. Thus, general prediction results may be slightly worse than expected, even for texts that appear in the training data.
12. The memory usage of training / evaluation is directly proportional to the size of the data 
    
* Installation (through ~Nix Flakes~)

Add this repository to your Flake inputs. This may look like this:
#+begin_src nix
{
  inputs = {
    its-jointprobability = {
      url = "github:openeduhub/its-jointprobability";
      # optional
      # can reduce the total size when installing the application, but may
      # cause problems due to breaking changes in some dependencies
      nixpkgs.follows = "nixpkgs"; 
    };
  };
}
#+end_src

** Standalone Application

The micro-service is provided both as a ~nixpkgs~ overlay and as an output (~packages.${system}.its-jointprobability~). Thus, it may be included through
#+begin_src nix
{
  outputs =
    {
      self,
      nixpkgs,
      its-jointprobability,
      ...
    }:
    let
      system = "x86_64-linux";
      pkgs = nixpkgs.legacyPackages.${system}.extend
        its-jointprobability.overlays.default;
    in
    { };
}
#+end_src

** Python Library

The Python library is also provided as an overlay. Please not that this requires a version of ~nixpkgs~ later than =02b8c7ddb7fe956871fa65466bf8a30fa69ec078=, from 2024-03-14 (i.e. =nixos-24.05= or later, or =nixpkgs-unstable= / =nixos-unstable=).
 
#+begin_src nix
{
  outputs =
    {
      self,
      nixpkgs,
      its-jointprobability,
      ...
    }:
    let
      system = "x86_64-linux";
      pkgs = nixpkgs.legacyPackages.${system}.extend
        its-jointprobability.overlays.python-lib;

      my-python = pkgs.python3.withPackages (
        py-pkgs: with py-pkgs; [
          # some examples
          pandas
          numpy
          # this library
          its-jointprobability
        ]
      );
    in
    { };
}
#+end_src

